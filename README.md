# U3 滑鼠自動測試系統

## 📖 專案簡介
自動化滑鼠滾輪測試系統，結合送餐機器人移動平台、HC-12 無線通訊、Arduino 繼電器控制、步進馬達輪盤系統、Sikuli 自動化測試與螢幕截圖功能，實現完全無人化的滑鼠產品測試流程。  
輔助SQA部門提高測試效率，支援**多趟測試**與**多角度輪盤測試**雙重模式。

## 🏗️ 系統架構
- **主控程式**: Python 3.10+ (asyncio 非同步架構)
- **移動平台**: 送餐機器人 (WebSocket 控制)
- **通訊模組**: HC-12 無線模組 (433MHz)
- **控制系統**: Arduino UNO + 繼電器模組 + 步進馬達輪盤
- **測試軟體**: Sikuli IDE 自動化測試
- **驅動設備**: 滑鼠滾輪馬達
- **記錄系統**: 自動截圖 + LOG 記錄

## ⚡ 系統特色
- ✅ **雙模式測試系統**：支援傳統多趟測試 + 輪盤角度測試
- ✅ **完全無人化測試**：支援夜間自動執行
- ✅ **多角度測試**：輪盤系統支援 0°, 45°, 90°, -45°, -90° 精確定位
- ✅ **智能路徑規劃**：機器人自動最佳化移動路徑
- ✅ **通訊容錯機制**：HC-12 重試機制確保穩定性
- ✅ **時間精確控制**：Arduino 70秒 + PC 80秒 同步執行
- ✅ **自動結果記錄**：截圖 + LOG 雙重記錄，支援角度分類
- ✅ **模組化設計**：各功能獨立測試，便於除錯維護

## 🔧 硬體配置

### Arduino UNO 接線圖 (HC-12 + 繼電器)
```
Arduino UNO:
├── Vin ────── 電池盒正極 (18650 三串 11V)
├── GND ────── 電池盒負極、HC-12 GND、繼電器 GND
├── D2  ────── HC-12 TXD (程式設定為 Rx)
├── D3  ────── HC-12 RXD (程式設定為 Tx)
├── D7  ────── 繼電器 IN
├── D13 ────── LED 狀態指示燈
└── 5V  ────── 繼電器 VCC、HC-12 VCC

繼電器模組:
├── VCC ────── Arduino 5V
├── GND ────── Arduino GND
├── IN  ────── Arduino D7
├── NO  ────── 滑鼠滾輪馬達正極
└── COM ────── 電池盒正極

滑鼠滾輪馬達:
├── 正極 ───── 繼電器 NO
└── 負極 ───── 電池盒負極

HC-12 無線模組:
├── VCC ────── Arduino 5V
├── GND ────── Arduino GND
├── TXD ────── Arduino D2 (Rx)
└── RXD ────── Arduino D3 (Tx)
```

### 輪盤系統接線圖 (步進馬達控制)
```
Arduino UNO (輪盤控制):
├── Vin ────── 由數據線連接PC提供電源
├── GND ────── 電源負極、驅動板 GND
├── D8  ────── ULN2003 IN4
├── D9  ────── ULN2003 IN3
├── D10 ────── ULN2003 IN2
├── D11 ────── ULN2003 IN1
└── 5V  ────── ULN2003 VCC

ULN2003 驅動板:
├── VCC ────── Arduino 5V
├── GND ────── Arduino GND
├── IN1-IN4 ── Arduino D11 ~ D8
└── 馬達接口 ── 28BYJ-48 步進馬達

28BYJ-48 步進馬達:
└── 5線接口 ── ULN2003 馬達接口
```

### 電源配置
- **Arduino 供電**: 18650 鋰電池三串 (11V) 或外部 9-12V
- **HC-12 供電**: Arduino 5V 輸出
- **繼電器供電**: Arduino 5V 輸出
- **步進馬達**: Arduino 5V 輸出（透過 ULN2003）
- **滑鼠馬達**: 電池盒直接供電 (透過繼電器開關)

## 💻 軟體環境

### Python 環境需求
```bash
# Python 版本
Python 3.10+

# 必要套件安裝
pip install pyserial websockets pyautogui PyGetWindow
```

### 必要軟體
- **Java JDK 17+**: 用於執行 Sikuli IDE
- **Arduino IDE**: 用於燒錄 Arduino 程式 (可選)

### 📁 專案檔案結構
```
Mouse_U3_Auto_Test_Main/
├── config.py                     # 統一設定檔
├── log_util.py                   # LOG 記錄系統
├── mouse_test_screenshot.py      # 截圖功能模組
├── robot_ws_client.py            # 機器人 WebSocket 控制
├── serial_util.py                # HC-12 串口通訊
├── turntable_controller.py       # 輪盤控制模組
├── HC12_Debug.py                 # HC-12 通訊測試工具
├── turntable_test.py             # 輪盤系統測試工具
├── U3_Mouse_Auto_Test_Main.py    # 主程式 (傳統多趟模式)
├── U3_Mouse_Auto_Test_Main_turntable.py  # 主程式 (輪盤模式)
├── sikulixide-2.0.5.jar          # ⚠️ 必須放在此資料夾內！(檔案過大 不在GitHub中)
└── U3_Mouse_Test.sikuli/         # ⚠️ Sikuli 測試腳本資料夾
```

### 驅動程式
- **CP2102 USB 轉串口驅動**: [下載連結](https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers)
CP210X Driver壓縮檔於跟目錄"Tool"資料夾內

## ⚙️ 設定檔說明

### config.py 參數配置
```python
# 硬體設定
COM_PORT = "COM3"                  # HC-12 串口號
TURNTABLE_COM_PORT = "COM5"        # 輪盤控制串口號
WS_IP = "192.168.0.225"            # 送餐機器人 IP 位址
WS_PORT = 8000                     # WebSocket 連接埠

# 測試點設定
TEST_POINT_PATTERN = '{:d}m'       # 測試點命名格式 (1m, 2m, 3m...)
TEST_POINT_RANGE = range(1, 11)    # 測試點範圍 (1~10m)

# 測試參數（僅一般模式使用 輪盤角度模式自動忽略此參數）
TEST_ROUNDS = 5                    # 測試趟數 (執行 5 趟完整測試)
```

## 🚀 使用方式

### 模式選擇
系統提供兩種測試模式：

#### 🔄 模式一：傳統多趟測試
```bash
python U3_Mouse_Auto_Test_Main.py
```
- 執行多趟相同路徑測試 (1m→2m→...→10m)
- 趟數由config.py中的 `TEST_ROUNDS` 控制
- 適合穩定性測試

#### 🎯 模式二：輪盤角度測試  
```bash
python U3_Mouse_Auto_Test_Main_turntable.py
```
- 執行多角度測試 (0°, 45°, 90°, -45°, -90°)
- 每個角度測試完整路徑 (1m→2m→...→10m)
- 適合Host方向性測試

### 1. 硬體準備
- [x] 確保 Arduino 電池電量充足 (11V+)
- [x] 檢查 HC-12 模組 與 Arduino LED 燈號正常(收到Host端 HC-12 通訊時會閃燈三次)
- [x] 檢查輪盤系統步進馬達正常運作
- [x] 確認滑鼠滾輪馬達正常運作
- [x] 啟動送餐機器人系統

### 2. 系統測試 (建議順序)
```bash
# 1. 測試 HC-12 通訊
python HC12_Debug.py

# 2. 測試輪盤系統 (僅輪盤模式需要)
python turntable_test.py

# 3. 選擇主程式執行
python U3_Mouse_Auto_Test_Main.py           # 傳統模式
# 或
python U3_Mouse_Auto_Test_Main_turntable.py # 輪盤模式
```

### 3. 測試流程

#### 傳統模式流程
```
1. 🚀 自動啟動 Sikuli 測試軟體
2. 🔄 執行 N 趟測試：
   ├── 🎯 機器人移動到測試點 (1m → 2m → ... → 10m)
   ├── 📡 HC-12 通訊控制 Arduino 啟動滾輪 (70 秒)
   ├── ⌨️  自動按下空白鍵開始測試錄製 (80 秒)
   └── 📸 自動截圖保存測試結果
3. 🏠 所有測試完成後機器人返回原點
```

#### 輪盤模式流程
```
1. 🚀 自動啟動 Sikuli 測試軟體
2. 🔄 依序執行各角度測試：
   ├── 🎯 輪盤旋轉到指定角度 (0° → 45° → 90° → -45° → -90°)
   ├── 🚗 機器人移動測試路徑 (1m → 2m → ... → 10m)
   ├── 📡 每個測試點進行 HC-12 通訊控制
   ├── ⌨️  自動測試錄製 (80 秒)
   └── 📸 按角度分類截圖保存
3. 🏠 輪盤返回 0° 位置，機器人返回原點
```

## 📊 輸出結果

### LOG 檔案格式
```
路徑: ../LOG/
傳統模式: YYYY-MM-DD_Mouse_Test_LOG_N.txt
輪盤模式: YYYY-MM-DD_Mouse_Test_Turntable_LOG_N.txt

內容包含:
- 詳細執行步驟記錄
- HC-12 通訊狀態
- 輪盤旋轉狀態 (輪盤模式)
- 時間控制資訊
- 錯誤處理記錄
```

### 截圖檔案結構

#### 傳統模式截圖
```
../Result_Screen_Shot/
├── 20250711_Mouse_Test_Result_1/          # 第 1 趟測試
│   ├── 20250711_Mouse_Test_1m_R1_143052.png
│   ├── 20250711_Mouse_Test_2m_R1_143127.png
│   └── ... (1m~10m)
├── 20250711_Mouse_Test_Result_2/          # 第 2 趟測試
└── ... (共 N 趟)
```

#### 輪盤模式截圖
```
../Result_Screen_Shot/
├── 20250711_Mouse_Test_Turntable_Angle_0/     # 0° 角度測試
│   ├── 20250711_Mouse_Test_Turntable_1m_0deg_143052.png
│   ├── 20250711_Mouse_Test_Turntable_2m_0deg_143127.png
│   └── ... (1m~10m)
├── 20250711_Mouse_Test_Turntable_Angle_45/    # 45° 角度測試
├── 20250711_Mouse_Test_Turntable_Angle_90/    # 90° 角度測試
├── 20250711_Mouse_Test_Turntable_Angle_-45/   # -45° 角度測試
└── 20250711_Mouse_Test_Turntable_Angle_-90/   # -90° 角度測試
```

## 🛠️ 故障排除

### 輪盤系統故障排除

#### 步進馬達不轉動
```
症狀: 發送旋轉指令但馬達無反應
解決方案:
1. 檢查輪盤系統串口設定 (TURNTABLE_COM_PORT)
2. 確認接線順序為 11,10,9,8 (對應IN1~4)
3. 檢查 ULN2003 驅動板電源供應
4. 使用 turntable_test.py 獨立測試
5. 確認 Arduino 燒錄程式正確
```

#### 旋轉方向錯誤
```
症狀: 指令 45° 但逆時針旋轉
解決方案:
1. 檢查步進馬達接線順序
2. 確認使用正確的接線順序 (11,10,9,8)
3. 如需修正方向，請調整硬體接線而非軟體
```

#### 輪盤超時錯誤
```
症狀: 等待旋轉完成訊息超時
解決方案:
1. 檢查步進馬達負載是否過重
2. 確認 Arduino 串口通訊正常
3. 增加旋轉完成 timeout 時間 (預設 45 秒)
4. 檢查馬達電源供應穩定性
```

### 傳統故障排除

#### HC-12 通訊失敗
```
症狀: 等待 Test_Start 超時
解決方案:
1. 檢查 HC-12 串口設定 (COM_PORT)
2. 確認電池電量充足
3. 充新插拔 Host 端 HC-12 的 USB-TTL 
4. 撥動 L 型開關關閉 Arduino 後重啟來重置 HC-12
5. 使用 HC12_Debug.py 測試通訊
```

#### 截圖功能卡住
```
症狀: 程式在截圖階段停止回應
解決方案:
1. 刪除舊的 Result_Screen_Shot 資料夾
2. 確認磁碟空間充足
3. 檢查防毒軟體是否阻擋
4. 重新啟動程式
```

#### Sikuli 啟動失敗
```
症狀: 測試軟體無法開啟
解決方案:
1. ⚠️ 確認 sikulixide-2.0.5.jar 在正確位置
2. ⚠️ 確認 U3_Mouse_Test.sikuli/ 資料夾存在
3. 檢查 Java JDK 安裝 (java -version)
4. 手動測試: 單獨開啟 Sikuli 讀取舊檔 "U3_Mouse_Test.sikuli" 並執行 
```

### 模組化除錯流程
```
1. 🔧 HC-12 通訊測試:    python HC12_Debug.py
2. 🔄 輪盤系統測試:      python turntable_test.py  
3. 🌐 WebSocket 連線測試: 檢查機器人系統狀態 (第一次連線必定失敗 必須前往工程模式將遠端控制系統開啟後再關閉 重置網路狀態即可)
4. 📷 Sikuli 功能測試:   手動執行 Sikuli 腳本
5. 🚀 主程式整合測試:    選擇對應模式執行
```

## 📈 系統效能

### 時間控制
- **單點測試時間**: 150 秒 (2.5 分鐘)
- **HC-12 通訊時間**: 通常 3-5 秒，最多 31 秒 (含重試)
- **輪盤旋轉時間**: 約 10-30 秒 (依角度而定)
- **實際測試時間**: 80 秒 (固定)
- **截圖處理時間**: 2-3 秒

### 輪盤系統效能
- **旋轉精度**: ±1° (步進馬達精度)
- **支援角度**: 0°, ±45°, ±90°, ±135°, ±180°
- **最大旋轉速度**: 3 RPM (可調整 "45.imo" 中的此行 "myStepper.setSpeed(3);" )
- **連續運作時間**: 2+ 小時

### 可靠性設計
- **HC-12 重試機制**: 最多 2 次重試，每次 15 秒 timeout
- **輪盤重試機制**: 旋轉失敗自動跳過該角度
- **通訊失敗處理**: 自動跳過失敗點，繼續下一個測試
- **模組化除錯**: 各子系統可獨立測試驗證

## 📚 程式架構

### 模組化設計 (v4.0)
```
U3_Mouse_Auto_Test_Main.py          # 傳統多趟測試主程式
U3_Mouse_Auto_Test_Main_turntable.py # 輪盤測試主程式
├── config.py                       # 統一設定檔管理
├── robot_ws_client.py              # 機器人 WebSocket 控制  
├── serial_util.py                  # HC-12 串口通訊
├── turntable_controller.py         # 輪盤控制模組
├── mouse_test_screenshot.py        # 截圖功能模組 (支援雙模式)
├── log_util.py                     # LOG 記錄系統
├── HC12_Debug.py                   # HC-12 獨立測試工具
└── turntable_test.py               # 輪盤獨立測試工具
```

### 設計原則
- **雙模式架構**: 傳統測試 + 輪盤測試並行支援
- **非同步架構**: 使用 asyncio 提升效能
- **模組化開發**: 各功能獨立，便於維護除錯
- **容錯設計**: 多層錯誤處理機制
- **硬體抽象**: 統一的硬體控制介面

## 📋 版本歷史
- **v4.0** (2025-07-11) - 新增輪盤系統支援，雙模式架構，模組化除錯工具
- **v3.0** (2025-06-19) - 修復截圖模組檔案衝突問題，優化時間控制邏輯，支援多趟測試
- **v2.0** (2025-06-18) - 加入 HC-12 通訊重試機制，統一訊息格式，提升通訊穩定性  
- **v1.0** (2025-06-17) - 基礎功能實現，整合各模組，建立完整測試流程

## 🎯 新功能特點 (v4.0)

### 輪盤系統整合
- **精確角度控制**: 步進馬達實現±1°精度
- **多角度測試**: 支援 0°, 45°, 90°, -45°, -90° 
- **智能路徑規劃**: 避免線材纏繞的相對角度移動
- **獨立測試功能**: `turntable_test.py` 支援手動測試

### 📊 智能分類系統
- **角度分類截圖**: 自動按角度建立資料夾
- **雙模式LOG**: 傳統模式與輪盤模式分別記錄
- **統一設定管理**: `config.py` 統一管理所有參數

### 🛠️ 模組化除錯
- **獨立模組測試**: 每個功能可單獨驗證
- **故障隔離**: 問題定位更加精確
- **向下相容**: 既有功能完全保留

## 👨‍💻 作者
**郭宇軒** - 自動化測試系統開發

專案開發歷程：四個月時間從構想到實現，經過多次查閱資料、除錯與優化，最終實現支援雙模式的穩定無人化測試系統。

## 📄 授權聲明
本專案僅供學習研究使用，請勿用於商業用途。

## 🤝 貢獻指南
歡迎提出建議和改進方案：
1. Fork 此專案
2. 建立功能分支 (`git checkout -b feature/新功能`)
3. 提交變更 (`git commit -am '新增某功能'`)
4. 推送到分支 (`git push origin feature/新功能`)
5. 建立 Pull Request

## 📞 技術支援
如有技術問題或建議，請透過 GitHub Issues 聯繫。

---
*最後更新: 2025年7月11日*
